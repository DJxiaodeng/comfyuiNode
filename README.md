# ComfyUI 自定义节点集合

这个项目包含了一系列为 ComfyUI 开发的自定义节点，旨在增强 AI 图像生成工作流程。目前包括图片信息查看节点和服装风格适配器两个主要组件。

## 项目组件

### 1. 图片信息查看节点

#### 功能简介

图片信息查看节点可以提取并显示 AI 生成图片的元数据信息，包括标签、种子、Lora 等。该节点可以帮助用户分析 AI 生成图片的参数和设置，便于复现或调整生成结果。

#### 主要特点

- **基本信息提取**：显示图片尺寸、格式、模式等基本信息
- **元数据解析**：解析 PNG 元数据，包括生成参数
- **提示词提取**：提取正面提示词和负面提示词
- **生成参数显示**：显示种子、采样器、步数、CFG 值等
- **模型信息**：提取模型信息和哈希值
- **Lora 识别**：识别并列出使用的 Lora 模型及其权重
- **批量处理**：支持批量处理多张图像
- **图像预览**：可生成带有信息的预览图像
- **颜色分析**：分析图像的主色调和颜色分布
- **信息保存**：支持将提取的信息保存到文本文件

#### 节点参数说明

##### 输入参数

| 参数名 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| image | IMAGE | 是 | 需要分析的图片 |
| analysis_mode | ["基本信息", "详细信息", "全部信息"] | 是 | 分析模式 |
| save_to_file | BOOLEAN | 否 | 是否将信息保存到文件（默认：False） |
| output_path | STRING | 否 | 保存信息的文件路径（默认："image_info.txt"） |
| generate_preview | BOOLEAN | 否 | 是否生成预览图像（默认：False） |
| analyze_colors | BOOLEAN | 否 | 是否分析图像颜色（默认：False） |
| color_sample_size | INT | 否 | 颜色采样大小（默认：1000） |

##### 输出参数

| 参数名 | 类型 | 说明 |
| --- | --- | --- |
| info | STRING | 提取的图片信息文本 |
| preview_image | IMAGE | 预览图像（如果启用） |

### 2. 服装风格适配器

#### 功能简介

服装风格适配器可以根据不同国家和地区的文化习惯自动调整服装风格，避开当地禁忌风格搭配。该节点可以帮助用户在生成跨文化内容时，确保服装风格符合目标地区的文化习惯和审美偏好。

#### 主要特点

- **多地区支持**：支持中国、日本、印度、中东、欧洲、北美、非洲、东南亚、韩国、俄罗斯、拉丁美洲、北欧等多个地区的服装风格调整
- **智能提示词生成**：根据地区特点自动生成适合的提示词和负面提示词
- **图像处理**：可选择性地对图像进行风格调整，使其更符合目标地区的审美
- **调整强度控制**：通过调整强度参数，控制风格转换的程度
- **风格预览**：自动保存风格预览图像，方便用户查看效果
- **种子控制**：支持设置随机种子，确保结果可复现

#### 节点参数说明

##### 输入参数

| 参数名 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| image | IMAGE | 是 | 输入图像 |
| region | [多个地区选项] | 是 | 目标地区 |
| adaptation_strength | FLOAT | 是 | 调整强度，范围0.0-1.0 |
| enable_image_processing | ["是", "否"] | 是 | 是否启用图像处理 |
| prompt | STRING | 否 | 原始提示词 |
| negative_prompt | STRING | 否 | 原始负面提示词 |
| seed | INT | 否 | 随机种子，设为0则自动生成 |
| steps | INT | 否 | 采样步数 |
| cfg | FLOAT | 否 | CFG比例 |
| sampler_name | [采样器列表] | 否 | 采样器名称 |

##### 输出参数

| 参数名 | 类型 | 说明 |
| --- | --- | --- |
| adapted_image | IMAGE | 调整后的图像 |
| adapted_prompt | STRING | 调整后的提示词 |
| adapted_negative_prompt | STRING | 调整后的负面提示词 |
| seed | INT | 使用的随机种子 |

### 3. 服装风格工作流节点

#### 功能简介

服装风格工作流节点基于服装风格适配器构建，提供了更完整的功能和更灵活的使用方式，使用户能够轻松创建符合特定地区文化特点的服装图像。

#### 主要特点

- **完整工作流**：提供从输入图像到输出调整后图像的完整处理流程
- **多种工作流模式**：支持完整工作流、仅提示词调整、仅图像处理等多种模式
- **风格信息显示**：提供专门的节点显示风格信息，方便用户了解地区特点
- **地区风格选择器**：可以直接选择特定地区的风格信息，无需输入图像

#### 节点类型

1. **服装风格工作流（ClothingStyleWorkflow）**：主要的工作流节点，提供完整的服装风格调整功能
2. **风格信息显示器（StyleInfoDisplay）**：用于显示服装风格信息的节点
3. **地区风格选择器（RegionalStyleSelector）**：用于直接选择特定地区的风格信息

## 安装方法

1. 确保已安装 ComfyUI
2. 将项目文件复制到 ComfyUI 的自定义节点目录中（通常为 `ComfyUI/custom_nodes/` 目录）
3. 重启 ComfyUI

## 使用示例

### 图片信息查看节点

1. 在 ComfyUI 工作流中添加「图片信息查看器」节点
2. 将需要分析的图片连接到节点的 `image` 输入端
3. 选择分析模式（基本信息、详细信息或全部信息）
4. 可选：设置是否生成预览、分析颜色、保存到文件等选项
5. 运行工作流，查看输出的信息

### 服装风格工作流

#### 基本工作流

1. 加载图像 → 服装风格工作流（地区：「中国」，调整强度：0.75）→ 预览图像
2. 服装风格工作流 → 风格信息显示器 → 文本显示

#### 高级工作流

1. 加载图像 + 文本提示词 + 负面提示词 → 服装风格工作流（地区：「日本」，调整强度：0.8）→ KSampler → 保存图像
2. 地区风格选择器（地区：「印度」）→ KSampler → 保存图像

## 技术实现细节

### 图片信息查看节点

- `ImageInfoExtractor` 类：主要的节点实现类
- `extract_info` 方法：节点的主要功能入口
- `_process_single_image` 方法：处理单张图像
- `_parse_png_metadata` 方法：解析 PNG 元数据
- `_extract_loras` 方法：提取 Lora 信息
- `_analyze_colors` 方法：分析图像颜色
- `_generate_preview` 方法：生成预览图像

### 服装风格适配器

- `ClothingStyleAdapter` 类：主要的适配器实现类
- `STYLE_DATABASE`：国家/地区服装风格数据库
- `STYLE_PROMPT_MAPPING`：风格转换提示词映射
- `adapt_style` 方法：风格适配的主要功能入口
- `generate_style_prompt` 方法：生成风格提示词

### 服装风格工作流

- `ClothingStyleWorkflow` 类：主要的工作流节点实现类
- `StyleInfoDisplay` 类：风格信息显示器节点
- `RegionalStyleSelector` 类：地区风格选择器节点

## 注意事项

- 图片信息查看节点主要支持从 PNG 图像中提取元数据
- 不同的 AI 图像生成工具可能使用不同的元数据格式，本节点主要支持 ComfyUI 和 Stable Diffusion WebUI 生成的图像
- 服装风格适配器的效果受到原始图像和提示词的影响，可能需要调整参数以获得最佳效果

## 贡献与反馈
欢迎提交issues和pull requests，共同改进这些节点！